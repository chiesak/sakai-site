name: Column Entry Manager

on:
  issues:
    types: [opened]

jobs:
  add-entry:
    if: contains(github.event.issue.body, '### タグ') && !contains(github.event.issue.body, '### 記事ID')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Add entry and commit
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const columnPath = 'data/column.json';
            const data = JSON.parse(fs.readFileSync(columnPath, 'utf8'));

            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;

            // Parse form fields from issue body
            function parseField(body, label) {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*([\\s\\S]*?)(?=\\n### |$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const tagsRaw = parseField(issueBody, 'タグ');
            const body = parseField(issueBody, '本文');

            // Parse tags (newline or comma separated from dropdown)
            const tags = tagsRaw.split(/[,\n]/).map(t => t.trim()).filter(t => t.length > 0);

            // Generate date and ID
            const now = new Date();
            const yyyy = now.getFullYear().toString();
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const todayPrefix = `${yyyy}${mm}${dd}`;
            const todayEntries = data.filter(e => e.id.startsWith(todayPrefix));
            const suffix = String.fromCharCode(97 + todayEntries.length);
            const id = `${todayPrefix}${suffix}`;

            const newEntry = { id, date: dateStr, title: issueTitle, tags, body };
            data.unshift(newEntry);
            fs.writeFileSync(columnPath, JSON.stringify(data, null, 2) + '\n', 'utf8');

            // Commit and push
            execSync('git config user.name "github-actions[bot]"');
            execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
            execSync('git add data/column.json');
            execSync(`git commit -m "Add column entry #${issueNumber}"`);
            execSync('git push');

            // Close issue with comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: '✅ コラムを追加しました！'
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

  edit-entry:
    if: contains(github.event.issue.body, '### 記事ID')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Edit entry and commit
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const columnPath = 'data/column.json';
            const data = JSON.parse(fs.readFileSync(columnPath, 'utf8'));

            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;

            function parseField(body, label) {
              const regex = new RegExp(`### ${label}[\\s\\S]*?\\n\\s*([\\s\\S]*?)(?=\\n### |$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const entryId = parseField(issueBody, '記事ID');
            const newTitle = parseField(issueBody, '新しいタイトル（変更する場合のみ）');
            const newTagsRaw = parseField(issueBody, '新しいタグ（変更する場合のみ）');
            const newBody = parseField(issueBody, '新しい本文（変更する場合のみ）');

            const idx = data.findIndex(e => e.id === entryId);
            if (idx === -1) {
              core.setFailed(`Entry not found: ${entryId}`);
              return;
            }

            if (newTitle) data[idx].title = newTitle;
            if (newTagsRaw) {
              const tags = newTagsRaw.split(/[,\n]/).map(t => t.trim()).filter(t => t.length > 0);
              if (tags.length > 0) data[idx].tags = tags;
            }
            if (newBody) data[idx].body = newBody;

            fs.writeFileSync(columnPath, JSON.stringify(data, null, 2) + '\n', 'utf8');

            execSync('git config user.name "github-actions[bot]"');
            execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
            execSync('git add data/column.json');
            execSync(`git commit -m "Edit column entry ${entryId} #${issueNumber}"`);
            execSync('git push');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ 記事 ${entryId} を修正しました！`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
