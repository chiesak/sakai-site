name: Add Column Entry

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'タイトル (Title)'
        required: true
        type: string
      tags:
        description: 'タグ (comma separated, e.g. 研究コラム,授業補足)'
        required: true
        default: '研究コラム'
        type: string
      body:
        description: '本文 (Body text)'
        required: true
        type: string

jobs:
  add-entry:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Add new entry to column.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'data/column.json';
            const data = JSON.parse(fs.readFileSync(path, 'utf8'));

            const now = new Date();
            const yyyy = now.getFullYear().toString();
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;

            // Generate unique ID: date + letter suffix
            const todayPrefix = `${yyyy}${mm}${dd}`;
            const todayEntries = data.filter(e => e.id.startsWith(todayPrefix));
            const suffix = String.fromCharCode(97 + todayEntries.length); // a, b, c...
            const id = `${todayPrefix}${suffix}`;

            // Parse tags from comma-separated string
            const tags = context.payload.inputs.tags
              .split(',')
              .map(t => t.trim())
              .filter(t => t.length > 0);

            const newEntry = {
              id,
              date: dateStr,
              title: context.payload.inputs.title,
              tags,
              body: context.payload.inputs.body
            };

            // Add new entry at the beginning
            data.unshift(newEntry);
            fs.writeFileSync(path, JSON.stringify(data, null, 2) + '\n', 'utf8');

            core.summary.addRaw(`Added entry: **${newEntry.title}** (${id})`);
            await core.summary.write();

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/column.json
          git commit -m "Add column entry: ${{ inputs.title }}"
          git push
